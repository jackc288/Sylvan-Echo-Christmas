<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Christmas Magic</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: "Helvetica Neue", sans-serif; }
        #container { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
        
        /* 1. é¡¶éƒ¨æ ‡é¢˜ */
        #top-title {
            position: absolute;
            top: 5vh;
            width: 100%;
            text-align: center;
            font-family: 'Georgia', serif;
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(to right, #ff4757, #2ed573, #ffa502);
            -webkit-background-clip: text;
            color: transparent;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
            z-index: 10;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        /* 2. å¯åŠ¨é®ç½© (iOS å¿…éœ€ & åŠ è½½çŠ¶æ€) */
        #start-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            transition: opacity 0.5s;
        }
        #loading-text { margin-bottom: 20px; color: #aaa; font-size: 14px; }
        #start-btn {
            padding: 15px 40px;
            font-size: 1.2rem;
            background: #444; /* åˆå§‹ç°è‰² */
            border: none;
            border-radius: 30px;
            color: #888;
            cursor: not-allowed;
            box-shadow: none;
            transition: all 0.3s;
        }
        #start-btn.ready {
            background: #ff4757;
            color: white;
            cursor: pointer;
            box-shadow: 0 0 20px #ff4757;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* 3. OK æ‰‹åŠ¿å¼¹çª— */
        #message-box {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 80%; max-width: 300px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.5);
            border-radius: 15px;
            color: #fff;
            font-size: 1.2rem;
            text-align: center;
            box-shadow: 0 0 30px rgba(255,215,0, 0.4);
            display: none; 
            z-index: 30;
        }

        /* 4. åº•éƒ¨ UI */
        #ui-layer {
            position: absolute; bottom: 30px; left: 0; width: 100%;
            text-align: center; z-index: 10; pointer-events: none;
        }
        .btn-group {
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(5px);
            padding: 10px; border-radius: 20px;
            display: inline-block;
        }
        button.model-btn {
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 15px; margin: 0 5px;
            border-radius: 12px; font-size: 14px;
        }
        button.model-btn.active { background: #ff4757; border-color: #ff4757; }

        /* 5. éšè—è§†é¢‘æº (ä¿æŒé€æ˜ä½†å ä½) */
        #video-preview {
            position: absolute; top: 0; left: 0;
            width: 1px; height: 1px;
            opacity: 0.01; pointer-events: none;
            transform: scaleX(-1);
        }

        /* è°ƒè¯•ä¿¡æ¯ */
        #debug {
            position: absolute; top: 5px; left: 5px;
            color: rgba(255,255,255,0.3); font-size: 10px; z-index: 5;
        }
    </style>
</head>
<body>

    <div id="start-overlay">
        <h1 style="margin-bottom: 10px;">ğŸ„ åœ£è¯å¥‡è¿¹</h1>
        <div id="loading-text">æ­£åœ¨åˆå§‹åŒ–èµ„æº...</div>
        <button id="start-btn" disabled>åŠ è½½ä¸­...</button>
        <p style="font-size: 10px; color: #666; margin-top: 20px; max-width: 80%;">
            è‹¥é•¿æ—¶é—´æ— ååº”ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ä½¿ç”¨ HTTPS
        </p>
    </div>

    <div id="top-title">mm, Happy Christmas</div>
    <div id="debug">ç³»ç»Ÿå°±ç»ª</div>
    
    <div id="message-box">
        âœ¨ åœ£è¯å¿«ä¹ï¼âœ¨<br>
        <span style="font-size:0.8em; opacity:0.9; margin-top:5px; display:block;">
            è¿™æ˜¯å±äºä½ çš„é­”æ³•æ—¶åˆ»<br>æ„¿ä½ ä»Šæ™šå¥½æ¢¦
        </span>
    </div>

    <video id="video-preview" playsinline webkit-playsinline muted autoplay></video>

    <div id="ui-layer">
        <div class="btn-group">
            <button onclick="switchModel('hachiware')" id="btn-hachiware" class="model-btn active">å°å…«</button>
            <button onclick="switchModel('usagi')" id="btn-usagi" class="model-btn">ä¹Œè¨å¥‡</button>
            <button onclick="switchModel('chiikawa')" id="btn-chiikawa" class="model-btn">å‰ä¾å¡å“‡</button>
        </div>
    </div>

    <div id="container"></div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { MMDLoader } from 'three/addons/loaders/MMDLoader.js';
        import { FilesetResolver, HandLandmarker } from 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/+esm';

        // --- æ ¸å¿ƒå˜é‡ ---
        let scene, camera, renderer, controls;
        let particles = [], particleGroup, starMesh;
        let currentModel = null;
        let currentModelName = 'hachiware';
        
        // çŠ¶æ€å˜é‡
        let targetShape = 'random'; 
        let handPosition = new THREE.Vector3(0, 0, 0); 
        let previousHandX = 0; // ç”¨äºè®¡ç®—æ‰‡åŠ¨é€Ÿåº¦
        let sceneRotationVelocity = 0; // åœºæ™¯æ—‹è½¬æƒ¯æ€§

        let handClenchLevel = 0; // 0=å¼ å¼€, 1=æ¡æ‹³
        let isHandDetected = false;

        // å‚æ•°
        const TREE_HEIGHT = 22;
        const TREE_RADIUS = 9;
        const PARTICLE_COUNT = 1500; 
        const MODELS = {
            'hachiware': './hachiware.pmx',
            'usagi': './usagi.pmx',
            'chiikawa': './chiikawa.pmx'
        };

        // DOM
        const loadingText = document.getElementById('loading-text');
        const startBtn = document.getElementById('start-btn');
        const debug = document.getElementById('debug');

        // --- 1. ç¨‹åºå…¥å£ï¼šå…ˆåŠ è½½ï¼Œåäº¤äº’ ---
        init3D(); // ç«‹å³åŠ è½½3Dåœºæ™¯
        preloadAI(); // ç«‹å³å¼€å§‹ä¸‹è½½AIæ¨¡å‹

        // æŒ‰é’®ç‚¹å‡»äº‹ä»¶ (è§£é”æ‘„åƒå¤´)
        startBtn.addEventListener('click', async () => {
            if (startBtn.disabled) return;
            
            startBtn.innerText = "å¯åŠ¨æ‘„åƒå¤´...";
            try {
                await startCamera();
                // æˆåŠŸåéšè—é®ç½©
                const overlay = document.getElementById('start-overlay');
                overlay.style.opacity = '0';
                setTimeout(() => overlay.style.display = 'none', 500);
                animate(); // å¼€å§‹æ¸²æŸ“å¾ªç¯
            } catch (err) {
                alert("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™: " + err);
                startBtn.innerText = "é‡è¯•";
            }
        });

        // --- 2. åœºæ™¯åˆå§‹åŒ– ---
        function init3D() {
            const container = document.getElementById('container');
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x050505, 0.02);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 45);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            container.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 1.0; 

            // ç¯å…‰
            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            const dl = new THREE.DirectionalLight(0xffffff, 1.2);
            dl.position.set(10, 20, 20);
            scene.add(dl);

            createParticles();
            createStar();
            loadMMDModel('hachiware');

            window.switchModel = (name) => {
                if (currentModelName === name) return;
                currentModelName = name;
                document.querySelectorAll('.model-btn').forEach(b => b.classList.remove('active'));
                document.getElementById(`btn-${name}`).classList.add('active');
                loadMMDModel(name);
            };
        }

        // --- 3. é¢„åŠ è½½ AI (å…³é”®ä¿®å¤ç‚¹) ---
        let handLandmarker;
        async function preloadAI() {
            try {
                loadingText.innerText = "æ­£åœ¨ä¸‹è½½ AI è¯†åˆ«æ¨¡å‹ (çº¦10MB)...";
                
                const vision = await FilesetResolver.forVisionTasks(
                    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
                );
                
                handLandmarker = await HandLandmarker.createFromOptions(vision, {
                    baseOptions: {
                        modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`,
                        delegate: "GPU"
                    },
                    runningMode: "VIDEO",
                    numHands: 1
                });

                // AI åŠ è½½å®Œæ¯•ï¼Œæ¿€æ´»æŒ‰é’®
                loadingText.innerText = "èµ„æºå‡†å¤‡å°±ç»ª";
                startBtn.disabled = false;
                startBtn.classList.add('ready');
                startBtn.innerText = "ç‚¹å‡»å¼€å§‹ä½“éªŒ";

            } catch (e) {
                loadingText.innerText = "AI æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•";
                loadingText.style.color = "red";
                console.error(e);
                debug.innerText = "Error: " + e.message;
            }
        }

        // --- 4. æ‘„åƒå¤´å¯åŠ¨ ---
        async function startCamera() {
            const video = document.getElementById("video-preview");
            // å¼ºåˆ¶å‰ç½®ï¼Œå…¼å®¹æ€§å†™æ³•
            const constraints = { 
                video: { 
                    facingMode: "user", 
                    width: { ideal: 640 }, 
                    height: { ideal: 480 } 
                },
                audio: false
            };

            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            
            return new Promise((resolve) => {
                video.onloadeddata = () => {
                    video.play();
                    resolve();
                };
            });
        }

        // --- 5. ç²’å­ç‰¹æ•ˆ (é‡‘è‰²ä¸ºä¸»+çº¢ç»¿ç‚¹ç¼€) ---
        function createParticles() {
            particleGroup = new THREE.Group();
            scene.add(particleGroup);

            const canvas = document.createElement('canvas');
            canvas.width = 32; canvas.height = 32;
            const ctx = canvas.getContext('2d');
            const grad = ctx.createRadialGradient(16,16,0, 16,16,16);
            grad.addColorStop(0, 'rgba(255,255,255,1)');
            grad.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.fillStyle = grad;
            ctx.fillRect(0,0,32,32);
            const tex = new THREE.CanvasTexture(canvas);

            for (let i = 0; i < PARTICLE_COUNT; i++) {
                let color, size;
                const r = Math.random();
                if (r < 0.15) { color = 0xFF4757; size = 1.0; } // çº¢
                else if (r < 0.30) { color = 0x2ED573; size = 1.0; } // ç»¿
                else { color = 0xFFD700; size = 0.6; } // é‡‘ (é»˜è®¤)

                const mat = new THREE.SpriteMaterial({ 
                    map: tex, color: color, 
                    transparent: true, opacity: 0.8, 
                    blending: THREE.AdditiveBlending 
                });
                const mesh = new THREE.Sprite(mat);
                mesh.position.set((Math.random()-0.5)*60, (Math.random()-0.5)*60, (Math.random()-0.5)*60);
                mesh.scale.set(size, size, 1);

                // æ ‘å½¢æ€
                const yNorm = i / PARTICLE_COUNT; 
                const y = yNorm * TREE_HEIGHT - (TREE_HEIGHT / 2); 
                const rad = TREE_RADIUS * (1 - yNorm); 
                const ang = i * 0.3;

                particles.push({
                    mesh: mesh,
                    initialPos: mesh.position.clone(),
                    treePos: new THREE.Vector3(Math.cos(ang)*rad, y, Math.sin(ang)*rad),
                    fireworkVel: new THREE.Vector3(),
                    baseScale: size
                });
                particleGroup.add(mesh);
            }
        }

        function createStar() {
            const geo = new THREE.OctahedronGeometry(1.5, 0);
            const mat = new THREE.MeshBasicMaterial({ color: 0xFFFF00, wireframe: true });
            starMesh = new THREE.Mesh(geo, mat);
            // å†…éƒ¨å‘å…‰
            starMesh.add(new THREE.Mesh(new THREE.SphereGeometry(0.8), new THREE.MeshBasicMaterial({color:0xFFFFFF})));
            starMesh.visible = false;
            scene.add(starMesh);
        }

        // --- 6. æ¨¡å‹ä¸éª¨éª¼ ---
        function loadMMDModel(name) {
            const path = MODELS[name];
            new MMDLoader().load(path, (mesh) => {
                if (currentModel) scene.remove(currentModel);
                currentModel = mesh;
                mesh.scale.set(1.5, 1.5, 1.5);
                mesh.position.set(12, -10, 0);
                
                mesh.material.forEach(m => {
                    m.emissive = new THREE.Color(0x444444);
                    if(name==='usagi') m.color.setHex(0xFFEEAA);
                    if(name==='hachiware') m.color.setHex(0xDDEEFF);
                });
                scene.add(mesh);
            }, null, (err) => { 
                console.error(err);
                debug.innerText = "æ¨¡å‹åŠ è½½å¤±è´¥";
            });
        }

        function updateBone() {
            if(!currentModel || !currentModel.skeleton) return;
            const bones = currentModel.skeleton.bones;
            const armL = bones.find(b => b.name === 'å·¦è…•');
            const armR = bones.find(b => b.name === 'å³è…•');
            
            if(armL && armR) {
                // æ ¹æ®æ¡æ‹³åº¦å¹³æ»‘æ’å€¼åŠ¨ä½œ
                const z = THREE.MathUtils.lerp(-0.8, 0.5, handClenchLevel);
                const x = THREE.MathUtils.lerp(0, -0.6, handClenchLevel);
                armL.rotation.z = z; armL.rotation.x = x;
                armR.rotation.z = -z; armR.rotation.x = x;
            }
        }

        // --- 7. æ‰‹åŠ¿ä¾¦æµ‹å¾ªç¯ ---
        let lastVideoTime = -1;
        function detectGesture() {
            const video = document.getElementById("video-preview");
            if (!handLandmarker || !video || video.paused) return;

            if (video.currentTime !== lastVideoTime) {
                lastVideoTime = video.currentTime;
                const res = handLandmarker.detectForVideo(video, performance.now());
                
                const msgBox = document.getElementById('message-box');
                const title = document.getElementById('top-title');

                if (res.landmarks && res.landmarks.length > 0) {
                    isHandDetected = true;
                    const lm = res.landmarks[0];
                    const wrist = lm[0];

                    // åæ ‡æ˜ å°„
                    const rawX = (0.5 - wrist.x); // -0.5 ~ 0.5
                    handPosition.set(rawX * 40, (0.5 - wrist.y) * 30, 10);

                    // --- è®¡ç®—æ‰‡åŠ¨ (Fanning) é€»è¾‘ ---
                    if (targetShape === 'firework') { // åªæœ‰å¼ æ‰‹æ—¶æ‰ç”Ÿæ•ˆ
                        // è®¡ç®—å½“å‰å¸§ä¸ä¸Šä¸€å¸§æ‰‹éƒ¨Xåæ ‡çš„å·®å€¼ (é€Ÿåº¦)
                        const deltaX = rawX - previousHandX;
                        // å¦‚æœé€Ÿåº¦å¤Ÿå¿«ï¼Œä¸”æ‰‹æŒå¼ å¼€ï¼Œåˆ™æ—‹è½¬åœºæ™¯
                        if (Math.abs(deltaX) > 0.015) {
                            // ç´¯åŠ æ—‹è½¬é€Ÿåº¦ (åå‘ä½¿å¾—æ›´è‡ªç„¶ï¼šæ‰‹å¾€å·¦åˆ’ï¼Œåœºæ™¯å¾€å³è½¬)
                            sceneRotationVelocity += deltaX * 1.5; 
                        }
                    }
                    previousHandX = rawX;

                    // è®¡ç®—æ¡æ‹³åº¦
                    const tips = [8,12,16,20];
                    let dist = 0;
                    tips.forEach(i => dist += Math.sqrt(Math.pow(lm[i].x-wrist.x,2) + Math.pow(lm[i].y-wrist.y,2)));
                    dist /= 4; 
                    
                    let targetClench = THREE.MathUtils.mapLinear(dist, 0.4, 0.2, 0, 1);
                    targetClench = THREE.MathUtils.clamp(targetClench, 0, 1);
                    handClenchLevel += (targetClench - handClenchLevel) * 0.1;

                    // çŠ¶æ€æœº
                    if (handClenchLevel > 0.7) targetShape = 'tree';
                    else if (handClenchLevel < 0.3) targetShape = 'firework';

                    // OK æ‰‹åŠ¿ (æ‹‡æŒ‡+é£ŸæŒ‡æåˆ, ä¸­æŒ‡ä¼¸ç›´)
                    const pinch = Math.sqrt(Math.pow(lm[4].x-lm[8].x,2) + Math.pow(lm[4].y-lm[8].y,2));
                    const middle = Math.sqrt(Math.pow(lm[12].x-wrist.x,2) + Math.pow(lm[12].y-wrist.y,2));
                    
                    if (pinch < 0.06 && middle > 0.3) {
                        msgBox.style.display = 'block';
                        title.style.opacity = 0.1;
                    } else {
                        msgBox.style.display = 'none';
                        title.style.opacity = 1;
                    }

                } else {
                    isHandDetected = false;
                    handClenchLevel = 0;
                    targetShape = 'random';
                }
            }
        }

        // --- 8. åŠ¨ç”»æ¸²æŸ“ ---
        function animate() {
            requestAnimationFrame(animate);
            detectGesture();
            
            const time = Date.now() * 0.001;

            // åº”ç”¨åœºæ™¯æ‰‡åŠ¨æ—‹è½¬
            if (Math.abs(sceneRotationVelocity) > 0.001) {
                scene.rotation.y += sceneRotationVelocity;
                sceneRotationVelocity *= 0.95; // é˜»å°¼è¡°å‡ï¼Œè®©æ—‹è½¬æ…¢æ…¢åœä¸‹
            } else {
                // å¦‚æœæ²¡æœ‰æ‰‹åŠ¨æ—‹è½¬ï¼Œæ¢å¤è‡ªåŠ¨ç¼“æ…¢æ—‹è½¬
                scene.rotation.y += 0.002;
            }

            // ç²’å­é€»è¾‘
            particles.forEach(p => {
                const cur = p.mesh.position;
                
                // æ˜Ÿæ˜Ÿè·Ÿéš
                if(starMesh) {
                    starMesh.visible = (targetShape==='tree' && handClenchLevel>0.8);
                    starMesh.rotation.y += 0.05;
                    starMesh.position.y = TREE_HEIGHT/2 + 3 + Math.sin(time*3)*0.5;
                }

                if (targetShape === 'tree') {
                    cur.lerp(p.treePos, 0.08);
                    // èºæ—‹ä¸Šå‡
                    const s = 0.5 * time;
                    const x = p.treePos.x*Math.cos(s) - p.treePos.z*Math.sin(s);
                    const z = p.treePos.x*Math.sin(s) + p.treePos.z*Math.cos(s);
                    // ç®€æ˜“è¦†ç›–
                    p.mesh.position.y += Math.sin(time*3 + cur.x)*0.02;

                } else if (targetShape === 'firework') {
                    if(p.fireworkVel.lengthSq()===0) {
                        p.fireworkVel.copy(cur).normalize().multiplyScalar(Math.random()*0.8+0.2);
                        p.fireworkVel.y += 0.15;
                    }
                    cur.add(p.fireworkVel);
                    p.fireworkVel.y -= 0.01;
                    p.mesh.material.opacity -= 0.015;
                    if(p.mesh.material.opacity<=0) {
                        p.mesh.position.set(0,0,0);
                        p.mesh.material.opacity = 1;
                        p.fireworkVel.set(0,0,0);
                    }
                } else {
                    cur.y += Math.sin(time+cur.x)*0.02;
                    cur.lerp(p.initialPos, 0.05);
                    p.mesh.material.opacity = 1;
                    p.fireworkVel.set(0,0,0);
                }
            });

            // æ¨¡å‹æ›´æ–°
            if(currentModel) {
                updateBone();
                if(isHandDetected) {
                    const target = handPosition.clone();
                    target.x += 12;
                    currentModel.lookAt(target);
                } else {
                    currentModel.rotation.set(0,0,0);
                }
            }

            controls.update(); // è™½ç„¶æ‰‹åŠ¨æ—‹è½¬äº†sceneï¼Œcontrolsä¾ç„¶éœ€è¦update
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
